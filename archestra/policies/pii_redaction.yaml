# ═══════════════════════════════════════════════════════════════════════════════
# ARCHESTRA POLICY: PII Redaction & Data Protection
# Comprehensive data sanitization before AI processing
# ═══════════════════════════════════════════════════════════════════════════════
apiVersion: archestra.io/v1alpha1
kind: Policy
metadata:
  name: pii-redaction-policy
  version: "2.0.0"
  description: "Advanced PII redaction with compliance mappings"
  labels:
    domain: privacy
    compliance: [GDPR, HIPAA, CCPA, SOC2]

spec:
  type: prompt_input  # Runs BEFORE data hits the LLM
  enabled: true
  
  # Global redaction settings
  settings:
    mode: strict  # strict | permissive | audit_only
    log_redactions: true
    preserve_format: true  # Keep string length for pattern analysis
    
  # ─────────────────────────────────────────────────────────────────────────────
  # REDACTION RULES (ordered by priority)
  # ─────────────────────────────────────────────────────────────────────────────
  rules:
    # ──── CREDENTIALS ────
    - name: mask-passwords
      description: "Redact passwords in various formats"
      priority: 100
      patterns:
        - "password[=:\\s]+([^\\s\"']+)"
        - "passwd[=:\\s]+([^\\s\"']+)"
        - "pwd[=:\\s]+([^\\s\"']+)"
        - "secret[=:\\s]+([^\\s\"']+)"
      replacement: "[REDACTED_CREDENTIAL]"
      action: mask
      compliance: [GDPR, SOC2]

    - name: mask-api-keys
      description: "Redact API keys and tokens"
      priority: 100
      patterns:
        - "api[_-]?key[=:\\s]+([A-Za-z0-9_\\-]{20,})"
        - "bearer\\s+([A-Za-z0-9_\\-\\.]+)"
        - "token[=:\\s]+([A-Za-z0-9_\\-]{20,})"
        - "sk-[A-Za-z0-9]{32,}"  # OpenAI style keys
        - "ghp_[A-Za-z0-9]{36}"  # GitHub PAT
      replacement: "[REDACTED_API_KEY]"
      action: mask
      compliance: [SOC2]

    # ──── USER IDENTIFIERS ────
    - name: mask-usernames
      description: "Redact usernames from logs"
      priority: 90
      patterns:
        - "user\\s+'([a-zA-Z0-9_\\-]+)'"
        - "user[=:\\s]+([a-zA-Z0-9_\\-]+)"
        - "username[=:\\s]+([a-zA-Z0-9_\\-]+)"
        - "login[=:\\s]+([a-zA-Z0-9_\\-]+)"
      replacement: "[REDACTED_USER]"
      action: mask
      compliance: [GDPR, CCPA]

    - name: mask-email-addresses
      description: "Redact email addresses"
      priority: 90
      patterns:
        - "[a-zA-Z0-9._%+\\-]+@[a-zA-Z0-9.\\-]+\\.[a-zA-Z]{2,}"
      replacement: "[REDACTED_EMAIL]"
      action: mask
      compliance: [GDPR, CCPA, HIPAA]

    - name: mask-phone-numbers
      description: "Redact phone numbers (various formats)"
      priority: 85
      patterns:
        - "\\+?1?[\\-\\s\\.]?\\(?\\d{3}\\)?[\\-\\s\\.]?\\d{3}[\\-\\s\\.]?\\d{4}"
        - "\\+\\d{1,3}[\\-\\s]?\\d{6,14}"
      replacement: "[REDACTED_PHONE]"
      action: mask
      compliance: [GDPR, CCPA, HIPAA]

    # ──── NETWORK DATA ────
    - name: mask-private-ips
      description: "Optionally hide internal network topology"
      priority: 50
      patterns:
        - "10\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}"
        - "172\\.(1[6-9]|2[0-9]|3[0-1])\\.\\d{1,3}\\.\\d{1,3}"
        - "192\\.168\\.\\d{1,3}\\.\\d{1,3}"
      replacement: "[INTERNAL_IP]"
      action: mask
      enabled: false  # Enable if internal topology is sensitive
      compliance: [SOC2]

    - name: mask-mac-addresses
      description: "Redact MAC addresses"
      priority: 50
      patterns:
        - "([0-9A-Fa-f]{2}[:\\-]){5}([0-9A-Fa-f]{2})"
      replacement: "[REDACTED_MAC]"
      action: mask
      compliance: [GDPR]

    # ──── FINANCIAL DATA ────
    - name: mask-credit-cards
      description: "Redact credit card numbers"
      priority: 100
      patterns:
        - "\\b(?:4[0-9]{12}(?:[0-9]{3})?|5[1-5][0-9]{14}|3[47][0-9]{13})\\b"
        - "\\b\\d{4}[\\-\\s]?\\d{4}[\\-\\s]?\\d{4}[\\-\\s]?\\d{4}\\b"
      replacement: "[REDACTED_CC]"
      action: mask
      compliance: [PCI-DSS, GDPR]

    - name: mask-ssn
      description: "Redact Social Security Numbers"
      priority: 100
      patterns:
        - "\\b\\d{3}[\\-\\s]?\\d{2}[\\-\\s]?\\d{4}\\b"
      replacement: "[REDACTED_SSN]"
      action: mask
      compliance: [HIPAA, CCPA]

    # ──── HEALTHCARE DATA (HIPAA) ────
    - name: mask-medical-record-numbers
      description: "Redact medical record identifiers"
      priority: 95
      patterns:
        - "MRN[=:\\s#]+([A-Z0-9]+)"
        - "patient[_\\-]?id[=:\\s]+([A-Z0-9]+)"
      replacement: "[REDACTED_MRN]"
      action: mask
      compliance: [HIPAA]

  # ─────────────────────────────────────────────────────────────────────────────
  # AUDIT LOGGING FOR REDACTIONS
  # ─────────────────────────────────────────────────────────────────────────────
  audit:
    enabled: true
    log_pattern_matches: true
    log_original_length: true  # Track redaction impact
    destination: /logs/pii_redaction_audit.jsonl
    retention_days: 30
    
  # ─────────────────────────────────────────────────────────────────────────────
  # COMPLIANCE REPORTING
  # ─────────────────────────────────────────────────────────────────────────────
  compliance:
    generate_reports: true
    report_schedule: daily
    include_metrics:
      - total_redactions_by_type
      - compliance_coverage
      - potential_violations